---
title: "R Notebook"
output: html_notebook
author: Marie MICHEL
---

```{r}
library(tidyverse)

vcf_file <- "/Users/m_michel/Documents/stageM2/poumons//DATA/to_reannotate/M376-N.exome.vcf"
#vcf_file <- "/Users/m_michel/Downloads/MAP177-ortho-primary-WES_absolute_curated_maf.vcf"

#stocke les lignes du fichier
vcf_lines <- readLines(vcf_file)

homo_vcf <- function(vcf_lines){
  noms_format = NULL
  noms_info = NULL
  #boucles sur les lignes du fichier
  
  ## cette boucle permet de récupérer les noms des colonnes à mettre dans le vcf
  ## ce sera divisé en trois listes : list, info et format 
  ## list : contient les infos des base du vcf CHROM POS etc
  ## info : ce qui est contenu dans la colonne info (si variant calling)
  ## format : ce qui sera décrit dans les échantillons (ex : AD, GT etc)
  ## on rajoute les colonnes pour chaque alt possibles (3 au max), sera complété par des NA plus tard si y'a rien
  for (i in 1:length(vcf_lines)){
    #ligne actuelle
    line <- vcf_lines[i]
    #récupération des noms de colonne
    if(str_detect(line,"^#{1}[^#]")){
      line <- sub(x = line, pattern="#",replacement="")
      list = str_split(as.character(line), "\t")
      #on stocke la position du champ info
      info <- which(list[[1]]=="INFO")
      format <- which(list[[1]]=="FORMAT")
      sample <-  which(list[[1]]=="FORMAT") + 1
      alt <- which(list[[1]]=="ALT")
      list[[1]] <- c(list[[1]][1:alt], "ALT2", "ALT3", list[[1]][(alt+1):length(list[[1]])] )

    }
    #on regarde les autres lignes
    else if(!str_detect(line,"^#{2}")){
      ligne_info <- strsplit(strsplit(line, "\t")[[1]][info], ";")
      ligne_format <- strsplit(strsplit(line, "\t")[[1]][format], ":")

      for (i in 1:length(ligne_format[[1]])){
        if(!(ligne_format[[1]][i] %in% noms_format)){
          
          noms_format <- c(noms_format, ligne_format[[1]][i])
        }
      }
  
      for (i in 1:length(ligne_info[[1]])){
        nom_info <- strsplit(ligne_info[[1]][i], "=")[[1]][1]
        #on ajoute les noms si ils ne sont pas déja mis
        if(!(nom_info %in% noms_info) & nom_info!="."){
          noms_info <- c(noms_info, nom_info)
        }
      }
    }
  }
  AD <- which(noms_format=="AD")
  noms_format <- c(noms_format[1:AD], "AD_REF", "AD_ALT", "AD_ALT2", "AD_ALT3", noms_format[(AD+1):length(noms_format)] )
  
  ## création du tableau vide
  tab <- as.data.frame(setNames(replicate(length(list[[1]])+length(noms_info)+length(noms_format), numeric(0), simplify=F), c(list[[1]], noms_info, noms_format)))


  ## cette boucle permet de remplir le tableau
  ## commence par remplir les colonnes de list
  ## puis info
  ## puis format
  j <- 1
  for (i in 1:length(vcf_lines)){
    #ligne actuelle
    line <- vcf_lines[i]
    if(!str_detect(line,"^#")){
      
      #on commence par récupérer les nucléotides REF et ALT
      val = str_split(as.character(line), "\t")
      pol <- str_split(val[[1]][alt], ",")
      tab[j, 1:(alt-1)] <- val[[1]][1:(alt-1)] 
      tab[j,alt] <- pol[[1]][1]
      tab[j,alt+1] <- pol[[1]][2]
      tab[j,alt+2] <- pol[[1]][3]
      tab[j, (alt+3):length(list[[1]])] <- val[[1]][(alt+1):length(val[[1]])] 
      
      #colonnes infos 
      ligne_info <- strsplit(strsplit(line, "\t")[[1]][info], ";")
      for (i in 1:length(ligne_info[[1]])){
         
        champs_info <- strsplit(ligne_info[[1]][i], "=")[[1]]
         
        if(!(is.na(champs_info[2]))){
           tab[j, which(colnames(tab)==champs_info[1] | colnames(tab)==paste("X",champs_info[1], sep="")) ] <- champs_info[2]
         }
         else{
           tab[j, which(colnames(tab)==champs_info[1] | colnames(tab)==paste("X",champs_info[1], sep="")) ] <- 1
         }
      }
      
      ligne_format <- strsplit(strsplit(line, "\t")[[1]][format], ":")
      ligne_sample <- strsplit(strsplit(line, "\t")[[1]][sample], ":")
      
      #colonnes format
      if(length(ligne_sample[[1]])==length(ligne_format[[1]])){
        for (k in 1:(length(ligne_sample[[1]]))){
          tab[j, which(colnames(tab)==ligne_format[[1]][k] | colnames(tab)==paste(ligne_format[[1]][k],"1", sep="."))] <- ligne_sample[[1]][k] ##quand deux colonnes ont le même nom = même info, devrait pas être gênant en théorie
          if(ligne_format[[1]][k]=="AD"){
            champs_sample <- strsplit(ligne_sample[[1]][k], ",")
            tab[j,which(colnames(tab)=="AD_REF")] <- champs_sample[[1]][1]    
            tab[j,which(colnames(tab)=="AD_ALT")] <- champs_sample[[1]][2] 
            tab[j,which(colnames(tab)=="AD_ALT2")] <- champs_sample[[1]][3] 
            tab[j,which(colnames(tab)=="AD_ALT3")] <- champs_sample[[1]][4] 
          }
        }
      }
      else{ #INDEL : longueur < il manque une info 
        for (k in 1:(length(ligne_sample[[1]]))){
          tab[j, which(colnames(tab)==ligne_format[[1]][k] | colnames(tab)==paste(ligne_format[[1]][k],"1", sep="."))] <- ligne_sample[[1]][k]
        }
        if(!("AD" %in% ligne_format[[1]])){
           if(tab[j,length(list[[1]])+length(noms_info)+1]=="1/1"){
              tab[j,which(colnames(tab)=="AD_REF")] <- paste("0",ligne_sample[[1]][3], sep=",")
              tab[j,which(colnames(tab)=="AD_REF")] <- 0     #AD_REF
              tab[j,which(colnames(tab)=="AD_ALT")] <- ligne_sample[[1]][3]     #AD_ALT1
           }
           else{ #0/1 normalement on aura que ça (pas de 2 ou autre) ==> ce code s'adapte à notre vcf .... 
              #j'ai choisi de mettre l'info dels mais ca sous-estime le nb de read 
              alt_read <- tab[j,which(colnames(tab)=="Dels")]
              ref_read <- as.numeric(ligne_sample[[1]][3])-as.numeric(alt_read)
              tab[j, which(colnames(tab)=="AD")] <- paste(ref_read, alt_read, sep=",")
              tab[j,which(colnames(tab)=="AD_REF")] <- ref_read
              tab[j,which(colnames(tab)=="AD_ALT")] <- alt_read
           }
        }
      }
  
      j <- j +1
    }
  }
  #enlève les colonnes redondantes qu'on a parsé
  format <- which(colnames(tab)=="FORMAT")
  info <- which(colnames(tab)=="INFO")
  sample <-  which(colnames(tab)=="FORMAT") + 1
  AD <- which(colnames(tab)=="AD")
  tab <- tab[,-(c(format, sample, info, AD))]
  return(tab)
}

tab <- homo_vcf(vcf_lines)
```
